---
# This front matter tells Jekyll to process this file
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Atlas | Global Water Body Surface Area Atlas</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ '/css/style.css' | relative_url }}">
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body class="map-page">
    <!-- Site Navigation -->
    <nav class="site-navigation">
        <div class="nav-wrapper">
            <a href="{{ '/' | relative_url }}" class="nav-logo">ðŸŒŠ Water Body Atlas</a>
            <ul class="nav-links">
                <li><a href="{{ '/' | relative_url }}" class="active">Atlas</a></li>
                <li>
                    <select id="galleryDropdown" onchange="if(this.value) window.open(this.value, '_blank'); this.value='';" style="padding: 0.5rem 1rem; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 0.95rem;">
                        <option value="">Gallery</option>
                        <!-- Populated dynamically from gallery_index.json -->
                    </select>
                    <script>
                    // Dynamically populate gallery dropdown from gallery_index.json
                    (function() {
                        fetch('{{ "/data/gallery_index.json" | relative_url }}')
                            .then(response => response.json())
                            .then(data => {
                                const dropdown = document.getElementById('galleryDropdown');
                                
                                // Add all items as simple list
                                data.forEach(item => {
                                    const option = document.createElement('option');
                                    option.value = item.path;
                                    option.textContent = item.title;
                                    dropdown.appendChild(option);
                                });
                            })
                            .catch(error => console.error('Error loading gallery index:', error));
                    })();
                    </script>
                </li>
                <li><a href="{{ '/methodology/' | relative_url }}">Methodology</a></li>
                <li><a href="{{ '/dataset/' | relative_url }}">Dataset</a></li>
                <li><a href="{{ '/about/' | relative_url }}">About</a></li>
            </ul>
        </div>
    </nav>
    
    <div id="sidebar">
        <div class="sidebar-content" id="sidebar-categories">
            <!-- Sidebar categories will be dynamically generated here -->
        </div>
    </div>
    
    <!-- Hidden template for category sections -->
    <template id="category-template">
        <div class="category-section" style="margin-bottom: 1.5rem;">
            <h3 class="category-title" style="margin-bottom: 0.5rem;"></h3>
            <div class="filter-section">
                <div style="position: relative;">
                    <select class="category-select" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 4px; font-size: 0.9rem; cursor: pointer; appearance: none;">
                        <option value="" selected disabled>-- Select a layer --</option>
                    </select>
                    <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;">â–¼</div>
                </div>
                <div class="active-layers" style="margin-top: 10px;">
                    <!-- Active layer pills will appear here -->
                </div>
            </div>
        </div>
    </template>
    
    <!-- Hidden checkboxes container (will be populated dynamically) -->
    <div id="hidden-checkboxes" style="display: none;"></div>
    
    <div id="map">
        <div id="legend" class="legend">
            <h4 id="legend-title">Map Legend</h4>
            <div id="legend-content"></div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="{{ '/js/map.js' | relative_url }}"></script>
    <script>
        // Wait for DOM to be ready before loading sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // Load sidebar configuration and generate UI dynamically
            fetch('{{ "/data/sidebar_config.json" | relative_url }}')
                .then(response => response.json())
                .then(config => {
                    generateSidebar(config);
                    initializeLayerControls();
                    // Initialize map after sidebar is ready
                    if (typeof initMap === 'function') {
                        initMap();
                        // Auto-load data and select ONLY first layer of first category
                        loadAllData().then(() => {
                            dataLoaded = true;
                            // Select only the first layer of the first category
                            if (config.length > 0 && config[0].layers && config[0].layers.length > 0) {
                                const firstCategory = config[0];
                                const firstLayer = firstCategory.layers[0];
                                console.log(`ðŸŽ¯ Auto-selecting first layer: ${firstLayer.name}`);
                                toggleLayer(firstCategory.id, firstLayer.id, true);
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading sidebar config:', error));
        });
        
        let activeLayers = new Map(); // categoryId -> Set of active layer IDs
        let layerInfo = {}; // Flatten all layers for easy access
        window.sidebarConfig = null; // Make config globally available for map.js
        
        function generateSidebar(config) {
            window.sidebarConfig = config; // Store config globally
            const container = document.getElementById('sidebar-categories');
            const template = document.getElementById('category-template');
            const hiddenCheckboxes = document.getElementById('hidden-checkboxes');
            
            config.forEach(category => {
                // Create category section from template
                const categoryEl = template.content.cloneNode(true);
                const section = categoryEl.querySelector('.category-section');
                section.dataset.categoryId = category.id;
                
                // Set title
                categoryEl.querySelector('.category-title').textContent = category.category;
                
                // Populate dropdown
                const select = categoryEl.querySelector('.category-select');
                select.id = `${category.id}-select`;
                
                category.layers.forEach(layer => {
                    const option = document.createElement('option');
                    option.value = layer.id;
                    option.textContent = layer.name;
                    select.appendChild(option);
                    
                    // Store layer info
                    layerInfo[layer.id] = {
                        ...layer,
                        categoryId: category.id
                    };
                    
                    // Create hidden checkbox for map.js compatibility
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = layer.layerId;
                    hiddenCheckboxes.appendChild(checkbox);
                });
                
                // Initialize active layers set for this category
                activeLayers.set(category.id, new Set());
                
                container.appendChild(categoryEl);
            });
        }
        
        function initializeLayerControls() {
            // Setup event listeners for all category selects
            document.querySelectorAll('.category-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const layerId = e.target.value;
                    if (layerId) {
                        const layer = layerInfo[layerId];
                        toggleLayer(layer.categoryId, layerId, true);
                        e.target.value = ''; // Reset dropdown
                    }
                });
            });
        }
        
        let dataLoaded = false;
        
        function toggleLayer(categoryId, layerId, isActive) {
            const categorySet = activeLayers.get(categoryId);
            const layer = layerInfo[layerId];
            
            // Load data on first layer selection
            if (isActive && !dataLoaded && typeof loadAllData === 'function') {
                console.log('Loading data for the first time...');
                loadAllData().then(() => {
                    dataLoaded = true;
                    // After data loads, set the checkbox state
                    toggleLayerCheckbox(layer, isActive, categorySet, layerId, categoryId);
                });
            } else {
                toggleLayerCheckbox(layer, isActive, categorySet, layerId, categoryId);
            }
        }
        
        function toggleLayerCheckbox(layer, isActive, categorySet, layerId, categoryId) {
            if (isActive && !categorySet.has(layerId)) {
                categorySet.add(layerId);
                // Toggle map layer
                const checkbox = document.getElementById(layer.layerId);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                }
            } else if (!isActive && categorySet.has(layerId)) {
                categorySet.delete(layerId);
                // Toggle map layer off
                const checkbox = document.getElementById(layer.layerId);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.dispatchEvent(new Event('change'));
                }
            }
            
            // Update pills display
            updateLayerPills(categoryId);
        }
        
        function updateLayerPills(categoryId) {
            const section = document.querySelector(`[data-category-id="${categoryId}"]`);
            const container = section.querySelector('.active-layers');
            const categorySet = activeLayers.get(categoryId);
            
            container.innerHTML = '';
            
            if (categorySet.size === 0) {
                container.innerHTML = '<span style="color: #95a5a6; font-size: 0.85rem;">No layers selected</span>';
                return;
            }
            
            categorySet.forEach(layerId => {
                const layer = layerInfo[layerId];
                const pill = document.createElement('span');
                pill.className = 'layer-pill';
                pill.style.cssText = 'display: inline-block; background: rgba(255,255,255,0.2); color: white; padding: 0.3rem 0.6rem; border-radius: 12px; margin: 0.2rem; font-size: 0.85rem; cursor: pointer;';
                pill.innerHTML = `${layer.name} <span style="margin-left: 0.3rem; font-weight: bold;">Ã—</span>`;
                pill.onclick = () => toggleLayer(categoryId, layerId, false);
                container.appendChild(pill);
            });
        }
        
    </script>
</body>
</html>


